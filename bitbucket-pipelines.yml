image: golang:1.21

definitions:
  services:
    docker:
      memory: 2048
  caches:
    godeps: $GOPATH/pkg/mod
    docker-cache: /var/lib/docker

pipelines:
  branches:
    main:
      - parallel:
          - step:
              name: Lint & Test (gateway)
              caches:
                - godeps
              size: 2x
              script:
                - cd oauth-framework/dromos-oauth-gateway
                - go fmt ./...
                - go vet ./...
                - go mod tidy
                - go test ./...
              condition:
                changesets:
                  includePaths:
                    - 'dromos-oauth-gateway/**'
          - step:
              name: Lint & Test (broker)
              caches:
                - godeps
              size: 2x
              script:
                - cd oauth-framework/dromos-oauth-broker
                - go fmt ./...
                - go vet ./...
                - go mod tidy
                - go test ./...
              condition:
                changesets:
                  includePaths:
                    - 'dromos-oauth-broker/**'

      - step:
          name: Build & Push Broker Image
          image: mcr.microsoft.com/azure-cli
          services:
            - docker
          size: 2x
          caches:
            - docker-cache
          script:
            - |
              set -eo pipefail
              : "${AZURE_APP_ID:?AZURE_APP_ID repo variable required}"
              : "${AZURE_TENANT_ID:?AZURE_TENANT_ID repo variable required}"
              : "${AZURE_CLIENT_SECRET:?AZURE_CLIENT_SECRET repo variable required}"
              : "${ACR_LOGIN_SERVER:?ACR_LOGIN_SERVER repo variable required (e.g. dromos.azurecr.io)}"
              : "${ACR_NAME:?ACR_NAME repo variable required (e.g. dromos)}"
              : "${RESOURCE_GROUP:?RESOURCE_GROUP repo variable required}"
              IMAGE_NAME="oauth-broker"
              IMAGE_TAG="${BITBUCKET_COMMIT}"
              az login --service-principal -u "$AZURE_APP_ID" -p "$AZURE_CLIENT_SECRET" -t "$AZURE_TENANT_ID"
              az acr login --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP"
              docker build -t "${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}" -f oauth-framework/dromos-oauth-broker/Dockerfile oauth-framework/dromos-oauth-broker
              docker push "${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}"
          condition:
            changesets:
              includePaths:
                - 'dromos-oauth-broker/**'

      - step:
          name: Deploy Broker to Azure Container Apps
          image: mcr.microsoft.com/azure-cli
          script:
            - |
              set -eo pipefail
              : "${AZURE_APP_ID:?AZURE_APP_ID repo variable required}"
              : "${AZURE_TENANT_ID:?AZURE_TENANT_ID repo variable required}"
              : "${AZURE_CLIENT_SECRET:?AZURE_CLIENT_SECRET repo variable required}"
              : "${ACR_LOGIN_SERVER:?ACR_LOGIN_SERVER repo variable required}"
              : "${RESOURCE_GROUP:?RESOURCE_GROUP repo variable required}"
              : "${CONTAINER_APP_NAME_BROKER:?CONTAINER_APP_NAME_BROKER repo variable required}"
              # App env vars (set these in Bitbucket Repository Variables/Secrets)
              : "${DATABASE_URL:?DATABASE_URL required for broker}"
              : "${BASE_URL:?BASE_URL required for broker callbacks}"
              : "${ENCRYPTION_KEY:?ENCRYPTION_KEY (base64-32B) required}"
              : "${STATE_KEY:?STATE_KEY (base64-32B) required}"
              : "${REDIRECT_PATH:=/auth/callback}"
              : "${API_KEY:=}"
              : "${ALLOWED_CIDRS:=127.0.0.1/32,::1/128}"
              : "${ALLOWED_RETURN_DOMAINS:=localhost,127.0.0.1}"
              : "${PORT:=8080}"
              : "${REQUIRE_API_KEY:=false}"
              : "${REQUIRE_ALLOWLIST:=false}"
              : "${ENFORCE_RETURN_URL:=false}"
              : "${BROKER_API_KEY:=}"
              : "${ENFORCE_DB_SSL:=false}"
              : "${DB_SSLMODE:=disable}"
              : "${DB_SSLROOTCERT:=}"
              IMAGE_NAME="oauth-broker"
              IMAGE_TAG="${BITBUCKET_COMMIT}"
              az login --service-principal -u "$AZURE_APP_ID" -p "$AZURE_CLIENT_SECRET" -t "$AZURE_TENANT_ID"
              az containerapp update \
                --name "$CONTAINER_APP_NAME_BROKER" \
                --resource-group "$RESOURCE_GROUP" \
                --image "${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}" \
                --set-env-vars \
                  DATABASE_URL="$DATABASE_URL" \
                  BASE_URL="$BASE_URL" \
                  ENCRYPTION_KEY="$ENCRYPTION_KEY" \
                  STATE_KEY="$STATE_KEY" \
                  REDIRECT_PATH="$REDIRECT_PATH" \
                  API_KEY="$API_KEY" \
                  ALLOWED_CIDRS="$ALLOWED_CIDRS" \
                  ALLOWED_RETURN_DOMAINS="$ALLOWED_RETURN_DOMAINS" \
                  PORT="$PORT" \
                  REQUIRE_API_KEY="$REQUIRE_API_KEY" \
                  REQUIRE_ALLOWLIST="$REQUIRE_ALLOWLIST" \
                  ENFORCE_RETURN_URL="$ENFORCE_RETURN_URL" \
                  BROKER_API_KEY="$BROKER_API_KEY" \
                  ENFORCE_DB_SSL="$ENFORCE_DB_SSL" \
                  DB_SSLMODE="$DB_SSLMODE" \
                  DB_SSLROOTCERT="$DB_SSLROOTCERT"
          condition:
            changesets:
              includePaths:
                - 'dromos-oauth-broker/**'

      - step:
          name: Build & Push Gateway Image
          image: mcr.microsoft.com/azure-cli
          services:
            - docker
          size: 2x
          caches:
            - docker-cache
          script:
            - |
              set -eo pipefail
              : "${AZURE_APP_ID:?AZURE_APP_ID repo variable required}"
              : "${AZURE_TENANT_ID:?AZURE_TENANT_ID repo variable required}"
              : "${AZURE_CLIENT_SECRET:?AZURE_CLIENT_SECRET repo variable required}"
              : "${ACR_LOGIN_SERVER:?ACR_LOGIN_SERVER repo variable required}"
              : "${ACR_NAME:?ACR_NAME repo variable required}"
              : "${RESOURCE_GROUP:?RESOURCE_GROUP repo variable required}"
              IMAGE_NAME="oauth-gateway"
              IMAGE_TAG="${BITBUCKET_COMMIT}"
              az login --service-principal -u "$AZURE_APP_ID" -p "$AZURE_CLIENT_SECRET" -t "$AZURE_TENANT_ID"
              az acr login --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP"
              docker build -t "${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}" -f oauth-framework/dromos-oauth-gateway/Dockerfile oauth-framework/dromos-oauth-gateway
              docker push "${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}"
          condition:
            changesets:
              includePaths:
                - 'dromos-oauth-gateway/**'

      - step:
          name: Deploy Gateway to Azure Container Apps
          image: mcr.microsoft.com/azure-cli
          script:
            - |
              set -eo pipefail
              : "${AZURE_APP_ID:?AZURE_APP_ID repo variable required}"
              : "${AZURE_TENANT_ID:?AZURE_TENANT_ID repo variable required}"
              : "${AZURE_CLIENT_SECRET:?AZURE_CLIENT_SECRET repo variable required}"
              : "${ACR_LOGIN_SERVER:?ACR_LOGIN_SERVER repo variable required}"
              : "${RESOURCE_GROUP:?RESOURCE_GROUP repo variable required}"
              : "${CONTAINER_APP_NAME_GATEWAY:?CONTAINER_APP_NAME_GATEWAY repo variable required}"
              # Shared envs for gateway; DATABASE_URL not used by gateway but kept parallel for consistency
              : "${DATABASE_URL:=}"
              : "${BASE_URL:=}"
              : "${ENCRYPTION_KEY:=}"
              : "${STATE_KEY:?STATE_KEY (base64-32B) required}"
              : "${REDIRECT_PATH:=/auth/callback}"
              : "${API_KEY:=}"
              : "${ALLOWED_CIDRS:=127.0.0.1/32,::1/128}"
              : "${ALLOWED_RETURN_DOMAINS:=localhost,127.0.0.1}"
              : "${PORT:=8090}"
              : "${REQUIRE_API_KEY:=false}"
              : "${REQUIRE_ALLOWLIST:=false}"
              : "${ENFORCE_RETURN_URL:=false}"
              : "${BROKER_API_KEY:=}"
              : "${BROKER_BASE_URL:?BROKER_BASE_URL required (e.g. https://broker.example.com)}"
              IMAGE_NAME="oauth-gateway"
              IMAGE_TAG="${BITBUCKET_COMMIT}"
              az login --service-principal -u "$AZURE_APP_ID" -p "$AZURE_CLIENT_SECRET" -t "$AZURE_TENANT_ID"
              az containerapp update \
                --name "$CONTAINER_APP_NAME_GATEWAY" \
                --resource-group "$RESOURCE_GROUP" \
                --image "${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}" \
                --set-env-vars \
                  PORT="$PORT" \
                  BROKER_BASE_URL="$BROKER_BASE_URL" \
                  STATE_KEY="$STATE_KEY" \
                  BROKER_API_KEY="$BROKER_API_KEY" \
                  REQUIRE_API_KEY="$REQUIRE_API_KEY" \
                  REQUIRE_ALLOWLIST="$REQUIRE_ALLOWLIST" \
                  ENFORCE_RETURN_URL="$ENFORCE_RETURN_URL" \
                  ALLOWED_CIDRS="$ALLOWED_CIDRS" \
                  ALLOWED_RETURN_DOMAINS="$ALLOWED_RETURN_DOMAINS"
          condition:
            changesets:
              includePaths:
                - 'dromos-oauth-gateway/**'

    "feature/*":
      - step:
          name: Build (if broker changed)
          image: docker:24
          services:
            - docker
          script:
            - docker build -t tmp/broker -f oauth-framework/dromos-oauth-broker/Dockerfile oauth-framework/dromos-oauth-broker
          condition:
            changesets:
              includePaths:
                - 'dromos-oauth-broker/**'
      - step:
          name: Build (if gateway changed)
          image: docker:24
          services:
            - docker
          script:
            - docker build -t tmp/gateway -f oauth-framework/dromos-oauth-gateway/Dockerfile oauth-framework/dromos-oauth-gateway
          condition:
            changesets:
              includePaths:
                - 'dromos-oauth-gateway/**'

